{
  "info": {
    "_postman_id": "bndes-projetos-api-newman-collection",
    "name": "BNDES Projetos API (Newman) - Full (Logout no final) [FIXED v2]",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "if (!pm.environment.get('runId')) {",
          "  pm.environment.set('runId', String(Date.now()));",
          "}",
          "const runId = pm.environment.get('runId');",
          "const password = pm.environment.get('password') || 'Test@1234';",
          "pm.environment.set('password', password);",
          "if (!pm.environment.get('email_user1')) pm.environment.set('email_user1', `user1_${runId}@test.com`);",
          "if (!pm.environment.get('email_user2')) pm.environment.set('email_user2', `user2_${runId}@test.com`);",
          "pm.variables.set('ts', Date.now());",
          "pm.variables.set('startDate', '2025-01-01');",
          "pm.variables.set('endDate', '2025-12-31');"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "00 - Health (opcional)",
      "item": [
        {
          "name": "GET /actuator/health (se existir)",
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{baseUrl}}/actuator/health", "host": ["{{baseUrl}}"], "path": ["actuator", "health"] }
          },
          "event": [
            {
              "listen": "test",
              "script": { "type": "text/javascript", "exec": [
                "pm.test('Health deve responder 200/404 ou 401 (se protegido)', function () {",
                "  pm.expect([200,404,401]).to.include(pm.response.code);",
                "});"
              ]}
            }
          ]
        }
      ]
    },
    {
      "name": "01 - Auth (Register/Login/Refresh)",
      "item": [
        {
          "name": "POST /auth/register (User1)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{\n  \"email\": \"{{email_user1}}\",\n  \"password\": \"{{password}}\"\n}" },
            "url": { "raw": "{{baseUrl}}/auth/register", "host": ["{{baseUrl}}"], "path": ["auth", "register"] }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('Register User1: 201 ou 409 (já existe)', function () {",
              "  pm.expect([201,409]).to.include(pm.response.code);",
              "});"
            ]}}
          ]
        },
        {
          "name": "POST /auth/register (User2)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{\n  \"email\": \"{{email_user2}}\",\n  \"password\": \"{{password}}\"\n}" },
            "url": { "raw": "{{baseUrl}}/auth/register", "host": ["{{baseUrl}}"], "path": ["auth", "register"] }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('Register User2: 201 ou 409 (já existe)', function () {",
              "  pm.expect([201,409]).to.include(pm.response.code);",
              "});"
            ]}}
          ]
        },
        {
          "name": "POST /auth/login (invalid credentials) -> 401",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{\n  \"email\": \"nope_{{ts}}@test.com\",\n  \"password\": \"Wrong@1234\"\n}" },
            "url": { "raw": "{{baseUrl}}/auth/login", "host": ["{{baseUrl}}"], "path": ["auth", "login"] }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('Login inválido deve retornar 401', function () {",
              "  pm.expect(pm.response.code).to.equal(401);",
              "});"
            ]}}
          ]
        },
        {
          "name": "POST /auth/login (User1) -> salva token + refresh (se vier)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{\n  \"email\": \"{{email_user1}}\",\n  \"password\": \"{{password}}\"\n}" },
            "url": { "raw": "{{baseUrl}}/auth/login", "host": ["{{baseUrl}}"], "path": ["auth", "login"] }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('Login User1 deve retornar 200', function () {",
              "  pm.expect(pm.response.code).to.equal(200);",
              "});",
              "if (pm.response.code !== 200) { postman.setNextRequest(null); }",
              "const json = pm.response.json();",
              "pm.test('Login deve retornar token', function(){",
              "  pm.expect(json.token || json.accessToken).to.be.a('string').and.not.empty;",
              "});",
              "pm.environment.set('token_user1', json.token || json.accessToken);",
              "if (json.refreshToken) pm.environment.set('refresh_user1', json.refreshToken);",
              "if (json.refresh_token) pm.environment.set('refresh_user1', json.refresh_token);"
            ]}}
          ]
        },
        {
          "name": "POST /auth/refresh (User1) -> atualiza token (se implementado)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{\n  \"refreshToken\": \"{{refresh_user1}}\"\n}" },
            "url": { "raw": "{{baseUrl}}/auth/refresh", "host": ["{{baseUrl}}"], "path": ["auth", "refresh"] }
          },
          "event": [
            {
              "listen": "prerequest",
              "script": { "type": "text/javascript", "exec": [
                "if (!pm.environment.get('refresh_user1')) {",
                "  console.warn('Sem refresh_user1. Pulando refresh.');",
                "  postman.setNextRequest('POST /auth/login (User2) -> salva token');",
                "}"
              ]}
            },
            {
              "listen": "test",
              "script": { "type": "text/javascript", "exec": [
                "pm.test('Refresh deve retornar 200 (se implementado)', function () {",
                "  pm.expect(pm.response.code).to.equal(200);",
                "});",
                "const json = pm.response.json();",
                "pm.environment.set('token_user1', json.token || json.accessToken);",
                "if (json.refreshToken) pm.environment.set('refresh_user1', json.refreshToken);",
                "if (json.refresh_token) pm.environment.set('refresh_user1', json.refresh_token);"
              ]}
            }
          ]
        },
        {
          "name": "POST /auth/login (User2) -> salva token",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{\n  \"email\": \"{{email_user2}}\",\n  \"password\": \"{{password}}\"\n}" },
            "url": { "raw": "{{baseUrl}}/auth/login", "host": ["{{baseUrl}}"], "path": ["auth", "login"] }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('Login User2 deve retornar 200', function () {",
              "  pm.expect(pm.response.code).to.equal(200);",
              "});",
              "if (pm.response.code !== 200) { postman.setNextRequest(null); }",
              "const json = pm.response.json();",
              "pm.environment.set('token_user2', json.token || json.accessToken);"
            ]}}
          ]
        }
      ]
    },
    {
      "name": "02 - Projects (Auth + Permissões + CRUD)",
      "item": [
        {
          "name": "GET /projects (sem token) -> 401",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/projects?page=0&size=10",
              "host": ["{{baseUrl}}"],
              "path": ["projects"],
              "query": [{ "key": "page", "value": "0" }, { "key": "size", "value": "10" }]
            }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('Sem token deve retornar 401', function () {",
              "  pm.expect(pm.response.code).to.equal(401);",
              "});"
            ]}}
          ]
        },
        {
          "name": "POST /projects (User1) -> cria e salva projectId",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{token_user1}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Projeto User1 {{ts}}\",\n  \"description\": \"Criado via Newman\",\n  \"value\": 150000.00,\n  \"startDate\": \"{{startDate}}\",\n  \"endDate\": \"{{endDate}}\",\n  \"active\": true\n}"
            },
            "url": { "raw": "{{baseUrl}}/projects", "host": ["{{baseUrl}}"], "path": ["projects"] }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('Criar projeto deve retornar 201', function () {",
              "  pm.expect(pm.response.code).to.equal(201);",
              "});",
              "if (pm.response.code !== 201) {",
              "  console.error('Create project falhou. Body:', pm.response.text());",
              "  postman.setNextRequest(null);",
              "}",
              "const json = pm.response.json();",
              "pm.test('Resposta deve conter id', function () {",
              "  pm.expect(json.id).to.exist;",
              "});",
              "pm.environment.set('projectId_user1', json.id);"
            ]}}
          ]
        },
        {
          "name": "GET /projects (User1) -> lista",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{token_user1}}" }],
            "url": {
              "raw": "{{baseUrl}}/projects?page=0&size=10",
              "host": ["{{baseUrl}}"],
              "path": ["projects"],
              "query": [{ "key": "page", "value": "0" }, { "key": "size", "value": "10" }]
            }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('Listar projetos deve retornar 200', function () {",
              "  pm.expect(pm.response.code).to.equal(200);",
              "});"
            ]}}
          ]
        },
        {
          "name": "GET /projects/:id (User1) -> ok",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{token_user1}}" }],
            "url": { "raw": "{{baseUrl}}/projects/{{projectId_user1}}", "host": ["{{baseUrl}}"], "path": ["projects", "{{projectId_user1}}"] }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('Obter projeto do próprio usuário deve retornar 200', function () {",
              "  pm.expect(pm.response.code).to.equal(200);",
              "});"
            ]}}
          ]
        },
        {
          "name": "GET /projects/:id (User2) -> deve negar (403) ou 404",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{token_user2}}" }],
            "url": { "raw": "{{baseUrl}}/projects/{{projectId_user1}}", "host": ["{{baseUrl}}"], "path": ["projects", "{{projectId_user1}}"] }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('User2 não deve acessar projeto do User1 (403 ou 404)', function () {",
              "  pm.expect([403,404]).to.include(pm.response.code);",
              "});"
            ]}}
          ]
        },
        {
          "name": "PUT /projects/:id (User1) -> update",
          "request": {
            "method": "PUT",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{token_user1}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Projeto User1 (atualizado) {{ts}}\",\n  \"description\": \"Atualizado via Newman\",\n  \"value\": 200000.00,\n  \"startDate\": \"{{startDate}}\",\n  \"endDate\": \"{{endDate}}\",\n  \"active\": true\n}"
            },
            "url": { "raw": "{{baseUrl}}/projects/{{projectId_user1}}", "host": ["{{baseUrl}}"], "path": ["projects", "{{projectId_user1}}"] }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('Atualizar deve retornar 200', function () {",
              "  pm.expect(pm.response.code).to.equal(200);",
              "});"
            ]}}
          ]
        },
        {
          "name": "DELETE /projects/:id (User1) -> delete",
          "request": {
            "method": "DELETE",
            "header": [{ "key": "Authorization", "value": "Bearer {{token_user1}}" }],
            "url": { "raw": "{{baseUrl}}/projects/{{projectId_user1}}", "host": ["{{baseUrl}}"], "path": ["projects", "{{projectId_user1}}"] }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('Deletar deve retornar 204', function () {",
              "  pm.expect(pm.response.code).to.equal(204);",
              "});"
            ]}}
          ]
        },
        {
          "name": "GET /projects/:id (User1) -> depois do delete (404)",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{token_user1}}" }],
            "url": { "raw": "{{baseUrl}}/projects/{{projectId_user1}}", "host": ["{{baseUrl}}"], "path": ["projects", "{{projectId_user1}}"] }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('Depois do delete deve retornar 404', function () {",
              "  pm.expect(pm.response.code).to.equal(404);",
              "});"
            ]}}
          ]
        }
      ]
    },
    {
      "name": "03 - Logout + Token revogado (blacklist)",
      "item": [
        {
          "name": "POST /auth/logout (User1) -> revoga token",
          "request": {
            "method": "POST",
            "header": [{ "key": "Authorization", "value": "Bearer {{token_user1}}" }],
            "url": { "raw": "{{baseUrl}}/auth/logout", "host": ["{{baseUrl}}"], "path": ["auth", "logout"] }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('Logout deve retornar 200/204', function () {",
              "  pm.expect([200,204]).to.include(pm.response.code);",
              "});"
            ]}}
          ]
        },
        {
          "name": "GET /projects com token antigo do User1 após logout -> 401",
          "request": {
            "method": "GET",
            "header": [{ "key": "Authorization", "value": "Bearer {{token_user1}}" }],
            "url": {
              "raw": "{{baseUrl}}/projects?page=0&size=10",
              "host": ["{{baseUrl}}"],
              "path": ["projects"],
              "query": [{ "key": "page", "value": "0" }, { "key": "size", "value": "10" }]
            }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [
              "pm.test('Token revogado deve retornar 401', function () {",
              "  pm.expect(pm.response.code).to.equal(401);",
              "});"
            ]}}
          ]
        }
      ]
    }
  ]
}
